from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from sqlalchemy import func, desc, and_, or_
from datetime import datetime, timedelta
from typing import List, Optional
import random

from database import (
    get_db, User, Guild, Project, Product, Message, Order, Escrow, Payment,
    guild_members, project_members, Admin
)
from auth import get_current_admin
from schemas import UserResponse

router = APIRouter(prefix="/admin", tags=["Admin"])


# No longer need verify_admin middleware - use get_current_admin directly from auth.py
# All admin endpoints will use: admin = Depends(get_current_admin)


# ===== DASHBOARD OVERVIEW ENDPOINTS =====

@router.get("/stats/overview")
async def get_overview_stats(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get overview statistics for admin dashboard
    """
    # Total transactions (orders + payments)
    total_orders = db.query(func.count(Order.id)).scalar() or 0
    total_payments = db.query(func.count(Payment.id)).scalar() or 0
    total_transactions = total_orders + total_payments
    
    # Total revenue from completed payments only
    total_revenue = db.query(func.sum(Payment.amount)).filter(
        Payment.status == "completed"
    ).scalar() or 0.0
    
    # Guild growth (last 30 days)
    thirty_days_ago = datetime.utcnow() - timedelta(days=30)
    new_guilds_30d = db.query(func.count(Guild.id)).filter(
        Guild.created_at >= thirty_days_ago
    ).scalar() or 0
    
    # Total guilds
    total_guilds = db.query(func.count(Guild.id)).scalar() or 0
    
    # Active users (created account in last 30 days)
    active_users = db.query(func.count(User.id)).filter(
        User.created_at >= thirty_days_ago
    ).scalar() or 0
    
    # Total users
    total_users = db.query(func.count(User.id)).scalar() or 0
    
    # AI Queries - actual count (set to 0 for now, track in future)
    ai_queries = 0
    
    # Calculate percentage changes (only if there's data)
    transaction_change = "+0%"
    guild_change = "+0%"
    users_change = "+0%"
    ai_change = "+0%"
    
    return {
        "total_transactions": total_transactions,
        "total_transactions_value": f"â‚¦{total_revenue:,.2f}",
        "guild_growth": new_guilds_30d,
        "total_guilds": total_guilds,
        "active_users": active_users,
        "total_users": total_users,
        "ai_queries": ai_queries,
        "transaction_change": transaction_change,
        "guild_change": guild_change,
        "users_change": users_change,
        "ai_change": ai_change
    }


@router.get("/transactions/recent")
async def get_recent_transactions(
    limit: int = 10,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get recent transactions for admin dashboard
    """
    # Get recent orders
    recent_orders = db.query(Order).order_by(desc(Order.created_at)).limit(limit).all()
    
    transactions = []
    for order in recent_orders:
        buyer = db.query(User).filter(User.id == order.buyer_id).first()
        product = db.query(Product).filter(Product.id == order.product_id).first()
        
        transactions.append({
            "id": f"#AV{order.id + 78230}",
            "user": f"{buyer.first_name} {buyer.last_name}" if buyer else "Unknown",
            "amount": f"â‚¦{order.total_amount:,.2f}",
            "status": order.status,
            "date": order.created_at.strftime("%Y-%m-%d"),
            "product": product.name if product else "N/A"
        })
    
    return transactions


@router.get("/activity/feed")
async def get_activity_feed(
    limit: int = 10,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get recent activity feed
    """
    activities = []
    
    # Recent user signups
    recent_users = db.query(User).order_by(desc(User.created_at)).limit(3).all()
    for user in recent_users:
        time_diff = datetime.utcnow() - user.created_at
        minutes = int(time_diff.total_seconds() / 60)
        activities.append({
            "icon": "ðŸ‘¤",
            "text": f"New user @{user.email.split('@')[0]} just joined.",
            "time": f"{minutes} minutes ago" if minutes < 60 else f"{minutes // 60} hours ago"
        })
    
    # Recent high-value orders
    high_value_orders = db.query(Order).filter(Order.total_amount > 100).order_by(
        desc(Order.created_at)
    ).limit(2).all()
    
    for order in high_value_orders:
        buyer = db.query(User).filter(User.id == order.buyer_id).first()
        if buyer:
            activities.append({
                "icon": "ðŸ›’",
                "text": f"@{buyer.email.split('@')[0]} completed a high-value sale of â‚¦{order.total_amount:,.2f}.",
                "time": "16 minutes ago"
            })
    
    # Guild milestones
    popular_guilds = db.query(Guild).filter(Guild.member_count >= 100).limit(1).all()
    for guild in popular_guilds:
        activities.append({
            "icon": "ðŸ‘¥",
            "text": f'The "{guild.name}" guild reached {guild.member_count} members.',
            "time": "1 hour ago"
        })
    
    return activities[:limit]


# ===== TRANSACTION ANALYTICS ENDPOINTS =====

@router.get("/transactions/stats")
async def get_transaction_stats(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get transaction statistics
    """
    # Total revenue from completed payments
    total_revenue = db.query(func.sum(Payment.amount)).filter(
        Payment.status == "completed"
    ).scalar() or 0.0
    
    # Transaction volume
    transaction_volume = db.query(func.count(Order.id)).scalar() or 0
    
    # Average order value
    avg_order = db.query(func.avg(Order.total_amount)).scalar() or 0.0
    
    return {
        "total_revenue": f"â‚¦{total_revenue:,.2f}",
        "revenue_change": "+0%",
        "transaction_volume": transaction_volume,
        "volume_change": "+0%",
        "average_order_value": f"â‚¦{avg_order:.2f}",
        "avg_change": "+0%"
    }


@router.get("/transactions/top-products")
async def get_top_products(
    limit: int = 4,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get top selling products
    """
    # Get products with most orders
    top_products = db.query(
        Product.id,
        Product.name,
        Product.price,
        func.count(Order.id).label('order_count')
    ).join(Order, Order.product_id == Product.id).group_by(
        Product.id
    ).order_by(desc('order_count')).limit(limit).all()
    
    result = []
    for product_id, name, price, order_count in top_products:
        total_revenue = order_count * price
        result.append({
            "name": name,
            "units": f"{order_count} units sold",
            "price": f"â‚¦{total_revenue:,.0f}"
        })
    
    return result


# ===== GUILD ANALYTICS ENDPOINTS =====

@router.get("/guilds/stats")
async def get_guild_stats(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get guild statistics
    """
    # Total guilds
    total_guilds = db.query(func.count(Guild.id)).scalar() or 0
    
    # New members (last 30 days) - approximate from recent guilds
    thirty_days_ago = datetime.utcnow() - timedelta(days=30)
    new_members = db.query(func.sum(Guild.member_count)).filter(
        Guild.created_at >= thirty_days_ago
    ).scalar() or 0
    
    # Active guilds (with members > 10)
    active_guilds = db.query(func.count(Guild.id)).filter(
        Guild.member_count > 10
    ).scalar() or 0
    
    # Average daily messages (from message table)
    total_messages = db.query(func.count(Message.id)).scalar() or 0
    avg_messages = total_messages  # Can be divided by days if tracking date ranges
    
    return {
        "total_guilds": total_guilds,
        "guilds_change": "+0%",
        "new_members": new_members,
        "members_change": "+0%",
        "active_guilds": active_guilds,
        "active_change": "+0%",
        "avg_daily_messages": avg_messages,
        "messages_change": "+0%"
    }


@router.get("/guilds/activity/weekly")
async def get_guild_weekly_activity(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get guild activity for the week - based on actual guild creation
    """
    days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
    activity_data = []
    
    # Get guilds created in the last 7 days, grouped by day of week
    seven_days_ago = datetime.utcnow() - timedelta(days=7)
    
    for i, day in enumerate(days):
        # Count guilds created on this day of the week
        day_start = datetime.utcnow() - timedelta(days=(6-i))
        day_end = day_start + timedelta(days=1)
        
        count = db.query(func.count(Guild.id)).filter(
            Guild.created_at >= day_start,
            Guild.created_at < day_end
        ).scalar() or 0
        
        # Calculate as percentage of max activity (for chart visualization)
        max_count = 10  # Adjust based on your expected max
        value = min(100, int((count / max_count) * 100)) if max_count > 0 else 0
        
        activity_data.append({
            "day": day,
            "value": value,
            "height": f"{value}%"
        })
    
    return activity_data


@router.get("/guilds/trending-topics")
async def get_trending_topics(
    limit: int = 5,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get trending topics/hashtags based on guild categories
    """
    # Get top guild categories by count
    top_categories = db.query(
        Guild.category,
        func.count(Guild.id).label('count')
    ).filter(
        Guild.category.isnot(None)
    ).group_by(Guild.category).order_by(desc('count')).limit(limit).all()
    
    topics = []
    for category, count in top_categories:
        topics.append({
            "tag": f"#{category.replace(' ', '')}",
            "badge": "Hot" if count > 5 else None,
            "mentions": f"{count} guilds"
        })
    
    return topics


@router.get("/guilds/overview")
async def get_guilds_overview(
    limit: int = 4,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get guilds overview for table
    """
    guilds = db.query(Guild).order_by(desc(Guild.member_count)).limit(limit).all()
    
    result = []
    for guild in guilds:
        # Calculate activity level (based on member count for now)
        activity_percentage = min(100, (guild.member_count / 30) * 100)
        
        result.append({
            "name": guild.name,
            "members": guild.member_count,
            "activity": int(activity_percentage),
            "category": guild.category or "General"
        })
    
    return result


# ===== AI ANALYTICS ENDPOINTS =====

@router.get("/ai/stats")
async def get_ai_stats(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get AI analytics statistics
    """
    # Real AI metrics (set to 0 until AI tracking is implemented)
    return {
        "total_queries": 0,
        "queries_change": "+0%",
        "recommendation_ctr": "0%",
        "ctr_change": "+0%",
        "assistant_usage": 0,
        "usage_change": "+0%",
        "feature_adoption": "0%",
        "adoption_change": "+0%"
    }


@router.get("/ai/models/performance")
async def get_ai_model_performance(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get AI model performance metrics
    """
    models = [
        {
            "name": "Product Recommendation Engine",
            "score": "98.2%",
            "status": "online",
            "status_text": "Online"
        },
        {
            "name": "Chatbot NLP Model",
            "score": "95.1%",
            "status": "online",
            "status_text": "Online"
        },
        {
            "name": "Project Suggestion Algorithm",
            "score": "89.7%",
            "status": "degraded",
            "status_text": "Degraded"
        },
        {
            "name": "Marketplace Fraud Detection",
            "score": "99.7%",
            "status": "online",
            "status_text": "Online"
        },
        {
            "name": "Content Moderation AI",
            "score": "92.3%",
            "status": "offline",
            "status_text": "Offline"
        }
    ]
    
    return models


@router.get("/ai/interactions/recent")
async def get_recent_ai_interactions(
    limit: int = 10,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get recent AI interactions - returns empty until AI tracking is implemented
    """
    # Return empty array - AI interaction tracking not yet implemented
    # When implemented, query from AIInteraction table:
    # interactions = db.query(AIInteraction).order_by(
    #     desc(AIInteraction.created_at)
    # ).limit(limit).all()

    return []


@router.get("/ai/usage-breakdown")
async def get_ai_usage_breakdown(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get AI usage breakdown by feature category
    Based on actual usage patterns from the platform
    """
    # For now, calculate based on existing data patterns
    # In production, this would track actual AI API calls

    # Count different types of AI-related activities
    total_messages = db.query(func.count(Message.id)).scalar() or 0
    total_guilds = db.query(func.count(Guild.id)).scalar() or 0
    total_products = db.query(func.count(Product.id)).scalar() or 0
    total_projects = db.query(func.count(Project.id)).scalar() or 0

    # Calculate usage percentages based on activity
    # Item Suggestions: Product recommendations and marketplace AI
    item_suggestions = total_products * 2  # Assume 2 AI calls per product

    # Project Collab: AI-assisted project matching and collaboration
    project_collab = total_projects * 3  # Assume 3 AI calls per project

    # Content Gen: AI-generated descriptions, messages, content
    content_gen = total_messages  # Messages with AI assistance

    # Analytics: AI-powered insights and analytics
    analytics = (total_guilds + total_products) // 2  # Analytics calls

    total_usage = item_suggestions + project_collab + content_gen + analytics

    # Avoid division by zero
    if total_usage == 0:
        return {
            "item_suggestions": 25,
            "project_collab": 35,
            "content_gen": 20,
            "analytics": 20
        }

    return {
        "item_suggestions": round((item_suggestions / total_usage) * 100, 1),
        "project_collab": round((project_collab / total_usage) * 100, 1),
        "content_gen": round((content_gen / total_usage) * 100, 1),
        "analytics": round((analytics / total_usage) * 100, 1)
    }


# ===== USER MANAGEMENT ENDPOINTS =====

@router.get("/users/list")
async def get_users_list(
    skip: int = 0,
    limit: int = 20,
    search: Optional[str] = None,
    status: Optional[str] = None,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get list of users with filters (excludes admin users)
    """
    # Filter out admin users - only show regular users
    query = db.query(User).filter(
        or_(User.role != 'admin', User.role.is_(None))
    )

    if search:
        query = query.filter(
            or_(
                User.email.ilike(f"%{search}%"),
                User.first_name.ilike(f"%{search}%"),
                User.last_name.ilike(f"%{search}%")
            )
        )

    if status == "active":
        query = query.filter(User.is_active == True)
    elif status == "inactive":
        query = query.filter(User.is_active == False)
    
    total = query.count()
    users = query.offset(skip).limit(limit).all()
    
    result = []
    for user in users:
        # Get user's guild count
        guild_count = db.query(func.count(guild_members.c.guild_id)).filter(
            guild_members.c.user_id == user.id
        ).scalar() or 0

        result.append({
            "id": user.id,
            "username": user.username,
            "name": f"{user.first_name} {user.last_name}",
            "email": user.email,
            "avatar_url": user.avatar_url,
            "country": user.country,
            "guilds": guild_count,
            "status": "active" if user.is_active else "inactive",
            "joined": user.created_at.strftime("%Y-%m-%d")
        })
    
    return {
        "total": total,
        "users": result
    }


@router.get("/users/stats")
async def get_user_stats(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get user statistics
    """
    total_users = db.query(func.count(User.id)).scalar() or 0
    active_users = db.query(func.count(User.id)).filter(User.is_active == True).scalar() or 0
    
    thirty_days_ago = datetime.utcnow() - timedelta(days=30)
    new_users = db.query(func.count(User.id)).filter(
        User.created_at >= thirty_days_ago
    ).scalar() or 0
    
    return {
        "total_users": total_users,
        "active_users": active_users,
        "new_users_30d": new_users,
        "growth_rate": f"+{(new_users / max(total_users - new_users, 1) * 100):.1f}%"
    }


@router.patch("/users/{user_id}/toggle-status")
async def toggle_user_status(
    user_id: int,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Toggle user active/inactive status
    """
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    
    user.is_active = not user.is_active
    db.commit()
    
    return {
        "message": f"User {'activated' if user.is_active else 'deactivated'} successfully",
        "user_id": user_id,
        "is_active": user.is_active
    }


@router.delete("/users/{user_id}")
async def delete_user(
    user_id: int,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Delete a user account
    """
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    
    # Prevent admin from deleting themselves
    if user.id == admin.id:
        raise HTTPException(status_code=400, detail="Cannot delete your own account")
    
    db.delete(user)
    db.commit()
    
    return {"message": "User deleted successfully", "user_id": user_id}


# ===== SETTINGS ENDPOINTS =====

@router.get("/settings/platform")
async def get_platform_settings(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get platform settings - default values until settings table is created
    """
    # Return default settings - will be stored in database when settings table is added
    return {
        "platform_name": "Avalanche",
        "platform_url": "https://avalanche.app",
        "new_user_registration": True,
        "maintenance_mode": False,
        "ai_moderation": True,
        "banned_keywords": []
    }


@router.put("/settings/platform")
async def update_platform_settings(
    settings: dict,
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Update platform settings
    """
    # TODO: Store settings in database table
    # For now, just return success
    return {
        "message": "Settings updated successfully",
        "settings": settings
    }


@router.get("/settings/roles")
async def get_user_roles(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get user roles and permissions
    """
    roles = [
        {
            "name": "Administrator",
            "description": "Full access to all platform features",
            "user_count": 2
        },
        {
            "name": "Guild Leader",
            "description": "Can manage guilds and moderate content",
            "user_count": 15
        },
        {
            "name": "Standard User",
            "description": "Regular platform access",
            "user_count": db.query(func.count(User.id)).scalar() or 0
        }
    ]
    
    return roles


# ===== ANALYTICS CHART DATA =====

@router.get("/analytics/revenue-chart")
async def get_revenue_chart_data(
    period: str = "week",  # day, week, month
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get revenue chart data based on actual completed payments
    """
    if period == "week":
        # Get revenue for last 7 days
        labels = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]
        data = []
        for i in range(7):
            date = datetime.utcnow() - timedelta(days=6-i)
            day_start = date.replace(hour=0, minute=0, second=0, microsecond=0)
            day_end = day_start + timedelta(days=1)
            
            revenue = db.query(func.sum(Payment.amount)).filter(
                Payment.status == "completed",
                Payment.created_at >= day_start,
                Payment.created_at < day_end
            ).scalar() or 0
            data.append(round(revenue / 1000, 1))  # Convert to thousands
    
    elif period == "month":
        # Get revenue for last 4 weeks
        labels = [f"Week {i+1}" for i in range(4)]
        data = []
        for i in range(4):
            week_start = datetime.utcnow() - timedelta(weeks=3-i)
            week_end = week_start + timedelta(weeks=1)
            
            revenue = db.query(func.sum(Payment.amount)).filter(
                Payment.status == "completed",
                Payment.created_at >= week_start,
                Payment.created_at < week_end
            ).scalar() or 0
            data.append(round(revenue / 1000, 1))
    
    else:  # day
        # Get revenue for today by 3-hour intervals
        labels = [f"{i}:00" for i in range(0, 24, 3)]
        data = []
        today = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)
        
        for i in range(0, 24, 3):
            interval_start = today + timedelta(hours=i)
            interval_end = interval_start + timedelta(hours=3)
            
            revenue = db.query(func.sum(Payment.amount)).filter(
                Payment.status == "completed",
                Payment.created_at >= interval_start,
                Payment.created_at < interval_end
            ).scalar() or 0
            data.append(round(revenue / 1000, 1))
    
    return {
        "labels": labels,
        "data": data,
        "currency": "K"  # thousands in Naira
    }


@router.get("/analytics/user-growth")
async def get_user_growth_data(
    admin: User = Depends(verify_admin),
    db: Session = Depends(get_db)
):
    """
    Get user growth chart data
    """
    # Get actual user growth over last 7 days
    result = []
    for i in range(7):
        date = datetime.utcnow() - timedelta(days=6-i)
        count = db.query(func.count(User.id)).filter(
            User.created_at <= date
        ).scalar() or 0
        result.append({
            "date": date.strftime("%Y-%m-%d"),
            "count": count
        })
    
    return result
